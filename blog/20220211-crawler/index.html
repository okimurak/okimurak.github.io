<!doctype html><html dir=ltr lang=ja data-theme class=html><head><title>okimurak | okky
|
Web クローラーを AWS Lambda で動かした</title><meta charset=utf-8><meta name=generator content="Hugo 0.82.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content="okimurak | okky"><meta name=description content="
      Cloud Engineer


    "><link rel=stylesheet href=/scss/main.min.b2e0cb07595e3519ab1193bb421914e06c0e26b0cc561fef23b3c6131d4d2ffa.css integrity="sha256-suDLB1leNRmrEZO7QhkU4GwOJrDMVh/vI7PGEx1NL/o=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/custom.min.fc7cc0e5eb7f00e3c6c29338b9a82e93964555771a1d593c1ece705cb0d8e0ed.css integrity="sha256-/HzA5et/AOPGwpM4uaguk5ZFVXcaHVk8Hs5wXLDY4O0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/fontawesome/css/fontawesome.min.b1c4e6a10bdbab01f33fff9d78816ee68cf9a9a731f07668afd546a79924cb80.css integrity="sha256-scTmoQvbqwHzP/+deIFu5oz5qacx8HZor9VGp5kky4A=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/solid.min.423dee17c62f55fa733a4ee13e00d523dfce88cc4f4ab4549a24ba36bd9de681.css integrity="sha256-Qj3uF8YvVfpzOk7hPgDVI9/OiMxPSrRUmiS6Nr2d5oE=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/brands.min.b7d54133b27e5b4de15245b8e143de3e8ed2d674c706137274cedc9953f31917.css integrity="sha256-t9VBM7J+W03hUkW44UPePo7S1nTHBhNydM7cmVPzGRc=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=canonical href=https://okimurak.github.io/blog/20220211-crawler/><script type=text/javascript src=/js/anatole-header.min.46e6a54097480084f8f52c20ca1aa7425b4fad17029a887fd4017b12e311a72d.js integrity="sha256-RualQJdIAIT49SwgyhqnQltPrRcCmoh/1AF7EuMRpy0=" crossorigin=anonymous></script><script type=text/javascript src=/js/anatole-theme-switcher.min.5557c8ff5617a01067ac258fd70b9b992506e379317b0da51e5e0f6e018b408a.js integrity="sha256-VVfI/1YXoBBnrCWP1wubmSUG43kxew2lHl4PbgGLQIo=" crossorigin=anonymous></script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://okimurak.github.io/images/site-feature-image.png"><meta name=twitter:title content="Web クローラーを AWS Lambda で動かした"><meta name=twitter:description content="こんにちは。 今日は年末年始に Web クローラーを作ったので、備忘録としてまとめます。"><meta property="og:title" content="Web クローラーを AWS Lambda で動かした"><meta property="og:description" content="こんにちは。 今日は年末年始に Web クローラーを作ったので、備忘録としてまとめます。"><meta property="og:type" content="article"><meta property="og:url" content="https://okimurak.github.io/blog/20220211-crawler/"><meta property="og:image" content="https://okimurak.github.io/images/site-feature-image.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-02-11T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-11T00:00:00+00:00"><meta property="og:site_name" content="okky"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"blog","name":"Web クローラーを AWS Lambda で動かした","headline":"Web クローラーを AWS Lambda で動かした","alternativeHeadline":"","description":"
      
        こんにちは。 今日は年末年始に Web クローラーを作ったので、備忘録としてまとめます。


      


    ","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/okimurak.github.io\/blog\/20220211-crawler\/"},"author":{"@type":"Person","name":"okky"},"creator":{"@type":"Person","name":"okky"},"accountablePerson":{"@type":"Person","name":"okky"},"copyrightHolder":{"@type":"Person","name":"okky"},"copyrightYear":"2022","dateCreated":"2022-02-11T00:00:00.00Z","datePublished":"2022-02-11T00:00:00.00Z","dateModified":"2022-02-11T00:00:00.00Z","publisher":{"@type":"Organization","name":"okky","url":"https://okimurak.github.io","logo":{"@type":"ImageObject","url":"https:\/\/okimurak.github.io\/favicons\/favicon-32x32.png","width":"32","height":"32"}},"image":["https://okimurak.github.io/images/site-feature-image.png"],"url":"https:\/\/okimurak.github.io\/blog\/20220211-crawler\/","wordCount":"364","genre":[],"keywords":["AWS","TypeScript"]}</script></head><body class="body theme--light"><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
animated fadeInDown"><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/images/profile.jpeg alt="profile picture"><div class=sidebar__introduction-title><a href=/>okky</a></div><div class=sidebar__introduction-description><p>Cloud Engineer</p></div></div><ul class=sidebar__list><li class=sidebar__list-item><a href=https://twitter.com/okky_eng rel=me aria-label=Twitter title=Twitter><i class="fab fa-twitter fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://github.com/okimurak/ rel=me aria-label=GitHub title=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://www.linkedin.com/in/okimurak rel=me aria-label=LinkedIn title=LinkedIn><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://qiita.com/okky_eng rel=me aria-label=Qiita title=Qiita><i class="icon-qiita fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
okimurak | okky
2022</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.fae9ac8895995fe91958b3954be11e96025824a04770726a3531e119ddd2d576.js integrity="sha256-+umsiJWZX+kZWLOVS+EelgJYJKBHcHJqNTHhGd3S1XY=" crossorigin=anonymous></script></div></aside><main class=wrapper__main><header class=header><div class="animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span><span aria-hidden=true class=navbar-burger__line></span><span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu><li class=nav__list-item><a href=/ title>Home</a></li><li class=nav__list-item><a href=/blog/ title>Blogs</a></li><li class=nav__list-item><a href=/about/ title>About</a></li></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
animated fadeInDown"><div class=post__content><h1>Web クローラーを AWS Lambda で動かした</h1><p>こんにちは。
今日は年末年始に Web クローラーを作ったので、備忘録としてまとめます。</p><h2 id=動機>動機</h2><p>妻の仕事の作業として、毎週特定の曜日に Web ページへ手入力をしている作業があり、面倒と言っていました。</p><p>退屈な作業はコンピューターにやらせてしまえ、ということで Web クローラー作ろうと思ったわけです。
（あと TypeScript の勉強にもなるとも）</p><h2 id=構成>構成</h2><p>以下のような構成で作りました。</p><figure><img src=/images/2022/0211/puppeteer-lambda.drawio.svg width=700></figure><ul><li>Web クローラー : puppeteer</li><li>実装 : TypeScript</li><li>実行環境 : AWS Lambda</li><li>データストア : Amazon DynamoDB</li><li>テスト : Jest</li><li>インフラの定義 : Serverless Framework, (Terraform)</li><li>CI/CD パイプライン : Github Actions</li></ul><h3 id=puppeteer>puppeteer</h3><p><a href=https://github.com/puppeteer/puppeteer>puppeteer</a> はプログラムから API で Chrome ブラウザを制御できる Node.js のライブラリです。
JavaScript で作られており、同期処理を使って以下のように簡単に Web クローラーを実装できます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>puppeteer</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>require</span>(<span style=color:#e6db74>&#39;puppeteer&#39;</span>);

(<span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>browser</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>puppeteer</span>.<span style=color:#a6e22e>launch</span>(); <span style=color:#75715e>// ブラウザオブジェクト作成
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>browser</span>.<span style=color:#a6e22e>newPage</span>();
  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>page</span>.<span style=color:#66d9ef>goto</span>(<span style=color:#e6db74>&#39;https://example.com&#39;</span>);
  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>screenshot</span>({ <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;example.png&#39;</span> }); <span style=color:#75715e>// スクショ保存
</span><span style=color:#75715e></span>
  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>browser</span>.<span style=color:#a6e22e>close</span>();
})();
</code></pre></div><p>もちろん、<a href=https://github.com/puppeteer/puppeteer#usage-with-typescript>TypeScript でも書けます。</a></p><p>また、Chromium のヘッドレスブラウザ(GUI を使わず起動できるブラウザ)を内蔵しています。</p><h3 id=aws-lambda>AWS Lambda</h3><p><a href=https://aws.amazon.com/jp/lambda/>AWS Lambda(Lambda)</a> は AWS が提供している、サーバレスでアプリケーションコードを実行できるコンピューティングサービスです。</p><p>イベント駆動型のサービスとして使うことが一般的です。</p><p>今回は <a href=https://aws.amazon.com/jp/eventbridge/>EventBridge</a> も使って、特定の時間にイベントを発生させて Lambda を起動し、Web クローラーを実行させます。</p><h4 id=puppeteer-on-aws-lambda>puppeteer on AWS Lambda</h4><p>Lambda は保存できるコードのサイズに圧縮時 50 MB, 非圧縮時 250 MB までの制限があります。[<a href=https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/gettingstarted-limits.html#function-configuration-deployment-and-execution>参考</a>]</p><p>puppeteer はそのままだと、内蔵された Chromium ヘッドレスブラウザの容量が大きいせいでこの制限を超えてしまいます。
つまり、puppeteer のサイズを削減する必要があります。</p><p>そこで、puppeteer の Chromium ブラウザを Lambda 用に最適化して容量を削減した、<a href=https://github.com/alixaxel/chrome-aws-lambda>chrome-aws-lambda</a> を使います。
これにより、Lambda のコードのサイズ制限を回避できます。</p><p>ちなみに、先程のコードは下記のように置換する必要があります。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chromium</span>  <span style=color:#f92672>=</span> <span style=color:#66d9ef>require</span>(<span style=color:#e6db74>&#39;chrome-aws-lambda&#39;</span>);

(<span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>browser</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>chromium</span>.<span style=color:#a6e22e>puppeteer</span>.<span style=color:#a6e22e>launch</span>(); <span style=color:#75715e>// ブラウザオブジェクト作成
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>browser</span>.<span style=color:#a6e22e>newPage</span>();
  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>page</span>.<span style=color:#66d9ef>goto</span>(<span style=color:#e6db74>&#39;https://example.com&#39;</span>);
  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>screenshot</span>({ <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;example.png&#39;</span> }); <span style=color:#75715e>// スクショ保存
</span><span style=color:#75715e></span>
  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>browser</span>.<span style=color:#a6e22e>close</span>();
})();
</code></pre></div><h3 id=amazon-dynamodb>Amazon DynamoDB</h3><p><a href=https://aws.amazon.com/jp/dynamodb/>Amazon DynamoDB(DynamoDB)</a> は AWS マネージドの NoSQL データベースサービスです。</p><p>今回、Web サイトから取得したデータの内容によって、Web クローラーを起動時に行う処理が変わるため、データを保存する必要がありました。</p><p>簡単な構造化データを保存するだけで、AWS でインフラを構築しているということもあり DynamoDB を採用しました。</p><p>Web クローラーの実装では <a href=https://github.com/aws/aws-sdk-js-v3>aws-sdk</a> を使って DynamoDB とデータをやり取りしています。</p><p>(なお、DynamoDB は色々な事情により Terraform で構築しましたが、今回は割愛します。)</p><h3 id=serverless-framework>Serverless Framework</h3><p>Lambda と EventBridge をデプロイさせる役には <a href=https://www.serverless.com/framework>Serverless Framework</a> を使いました。</p><p>Serverless Framework はサーバレスに特化したインフラストラクチャとアプリケーションをデプロイするためのフレームワークです。
Serverless Framework では YAML ファイルにインフラを定義してデプロイをします。以下は Lambda + EventBridge の定義例になります。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>service</span>: <span style=color:#ae81ff>lambda</span>

<span style=color:#f92672>plugins</span>:
  - <span style=color:#ae81ff>serverless-plugin-typescript</span> <span style=color:#75715e># アプリケーションのコードに TypeScript を使うため</span>

<span style=color:#f92672>frameworkVersion</span>: <span style=color:#e6db74>&#34;2&#34;</span>

<span style=color:#f92672>provider</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>aws</span>
  <span style=color:#f92672>region</span>: <span style=color:#ae81ff>ap-northeast-1</span>
  <span style=color:#f92672>runtime</span>: <span style=color:#ae81ff>nodejs14.x</span>

<span style=color:#f92672>functions</span>:
  <span style=color:#f92672>lambda</span>:
    <span style=color:#f92672>handler</span>: <span style=color:#ae81ff>lambdaHandler.handler</span> <span style=color:#75715e># Lambda のコードを実行させるメソッド</span>
    <span style=color:#f92672>role</span>: <span style=color:#ae81ff>arn:aws:iam::XXXXXXXXXXXX:role/ExampleLambdaExecutionRole</span>
    <span style=color:#f92672>events</span>:
      - <span style=color:#f92672>schedule</span>:
          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
          <span style=color:#f92672>rate</span>: <span style=color:#ae81ff>cron(0 0 ? * MON-THU *)</span>
</code></pre></div><h3 id=github-actions>Github Actions</h3><p>CI/CD パイプラインには慣れていた Github Actions を使いました。
Github Actions はテストと Serverless Framework によるデプロイを実行する役になります。
なお、テストには JavaScript のテストライブラリ <a href=https://jestjs.io/ja/>Jest</a> を使っています。(今回割愛します)</p><p>Github Actions も YAML ファイルにデプロイするワークフローを定義します。
以下では、Github リポジトリからコードをチェックアウトし、Serverless Framework を使ってデプロイする例になります。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>on</span>:
  <span style=color:#f92672>push</span>:
    <span style=color:#f92672>branches</span>:
      - <span style=color:#ae81ff>main</span>

<span style=color:#f92672>jobs</span>:
  <span style=color:#f92672>apply</span>:
    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
    <span style=color:#f92672>permissions</span>:
      <span style=color:#f92672>id-token</span>: <span style=color:#ae81ff>write</span>
      <span style=color:#f92672>contents</span>: <span style=color:#ae81ff>read</span>
    <span style=color:#f92672>strategy</span>:
      <span style=color:#f92672>matrix</span>:
        <span style=color:#f92672>node-version</span>: [<span style=color:#ae81ff>14.</span><span style=color:#ae81ff>x]</span>

    <span style=color:#f92672>steps</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Check out repository</span> <span style=color:#75715e># リポジトリのチェックアウト</span>
      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v2</span>

    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Configure AWS</span> <span style=color:#75715e># Serverless Framework からでプロイするため AWS Credential を設定</span>
      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>aws-actions/configure-aws-credentials@master</span>
      <span style=color:#f92672>with</span>:
        <span style=color:#f92672>role-to-assume</span>: <span style=color:#ae81ff>${{ secrets.AWS_ROLE_ARN }}</span>
        <span style=color:#f92672>aws-region</span>: <span style=color:#ae81ff>${{ secrets.AWS_DEFAULT_REGION }}</span>

    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>serverless deploy</span> <span style=color:#75715e># https://github.com/serverless/github-action を使います。コードの記述量が減って便利です。</span>
      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>serverless/github-action@master</span>
      <span style=color:#f92672>with</span>:
        <span style=color:#f92672>args</span>: <span style=color:#ae81ff>deploy</span>
</code></pre></div><h2 id=まとめ>まとめ</h2><p>今回、puppeteer, Lambda, DynamoDB を使った Web クローラーを作った話をしました。
puppeteer 初心者でしたが、空いた時間に 3 日くらいで実装できました。
もし、Web ページへ煩雑な作業があるとき、作ってみてはいかがでしょうか。</p><p>Lambda や DynamoDB は無料利用枠もあるので、簡単な Web クローラーなら無料で使えると思います（私も無料枠に収まっています）[<a href=https://aws.amazon.com/jp/lambda/pricing/>Lambda 料金</a>][<a href=https://aws.amazon.com/jp/dynamodb/pricing/>DynamoDB 料金</a>]</p></div><div class=post__footer><span><a class=tag href=/tags/aws/>AWS</a><a class=tag href=/tags/typescript/>TypeScript</a></span></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
okimurak | okky
2022</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.fae9ac8895995fe91958b3954be11e96025824a04770726a3531e119ddd2d576.js integrity="sha256-+umsiJWZX+kZWLOVS+EelgJYJKBHcHJqNTHhGd3S1XY=" crossorigin=anonymous></script></body></html>